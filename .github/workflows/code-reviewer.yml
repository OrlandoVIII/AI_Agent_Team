name: Code Reviewer Agent

on:
  pull_request:
    branches:
      - develop
    types: [opened, synchronize, reopened]

jobs:
  review:
    name: AI Code Review
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install anthropic PyGithub requests

      - name: Run Code Reviewer Agent
        id: reviewer
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          REVIEWER_BOT_TOKEN: ${{ secrets.REVIEWER_BOT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.REVIEWER_BOT_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_FULL_NAME: ${{ github.repository }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          python .github/scripts/code_reviewer.py
          echo "verdict=approved" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Debug verdict
        run: |
          echo "Reviewer outcome: ${{ steps.reviewer.outcome }}"
          echo "Reviewer verdict: ${{ steps.reviewer.outputs.verdict }}"
          echo "PR branch: ${{ github.event.pull_request.head.ref }}"

      - name: Self-Healing Fix
        if: steps.reviewer.outcome == 'failure'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BACKEND_AGENT_TOKEN: ${{ secrets.BACKEND_AGENT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.BACKEND_AGENT_TOKEN }}
          REPO_FULL_NAME: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          REVIEW_BODY: "Critical issues found"
          REVIEWER_LOGIN: "opulence-reviewer-bot"
        run: |
          git clone https://x-access-token:${{ secrets.BACKEND_AGENT_TOKEN }}@github.com/${{ github.repository }}.git fix_workspace
          cd fix_workspace
          git checkout ${{ github.event.pull_request.head.ref }}
          git config user.name "AI Backend Dev Agent"
          git config user.email "backendagent@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.BACKEND_AGENT_TOKEN }}@github.com/${{ github.repository }}.git
          git checkout origin/develop -- .github/scripts/backend_agent_fix.py
          git checkout origin/develop -- .github/scripts/backend_agent_fix_prompt.txt
          python .github/scripts/backend_agent_fix.py

      - name: Fail if criticals found
        if: steps.reviewer.outcome == 'failure'
        run: exit 1